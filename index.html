<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ¯ãƒ³ã‚³ãƒ¡ ã‚³ãƒ¡ãƒ³ãƒˆå—ä¿¡ï¼ˆã‚®ãƒ•ãƒˆé‡‘é¡ãƒ»çµµæ–‡å­—ç”»åƒãƒ»èª­ã¿ä¸Šã’é™¤å¤–ï¼‰</title>
  <style>
    body { font-family: sans-serif; background: #222; color: #fff; }
    #status {
      position: fixed;
      top: 10px;
      left: 10px;
      background: #444;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      z-index: 1001;
      font-size: 1em;
    }
    #comments { margin: 60px 20px 20px 20px; }
    .comment {
      display: flex;
      align-items: center;
      background: #333;
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      position: relative;
    }
    .icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 10px;
      background: #444;
      object-fit: cover;
      flex-shrink: 0;
    }
    .comment-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 0;
    }
    .author {
      color: #ffd700;
      font-weight: bold;
      margin-right: 8px;
      white-space: nowrap;
    }
    .body {
      color: #fff;
      word-break: break-all;
      font-size: 1.3em;
      font-weight: bold;
    }
    .service {
      font-size: 0.75em;
      color: #aaa;
      margin-left: 6px;
      margin-top: 2px;
      align-self: flex-end;
    }
    #toggleSpeech {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 16px;
      background: #ffd700;
      color: #222;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      z-index: 1000;
    }
    #toggleSpeech.off {
      background: #666;
      color: #fff;
    }
    .gift {
      background: #4e2a8e !important;
      border: 2px solid #ffd700;
      box-shadow: 0 0 16px #ffd70080;
    }
    .gift .body {
      color: #ffd700;
      text-shadow: 0 0 8px #fff, 0 0 2px #ffd700;
    }
    .amount {
      color: #ffd700;
      font-size: 1.2em;
      font-weight: bold;
      margin-top: 4px;
      align-self: flex-start;
      text-shadow: 0 0 8px #fff, 0 0 2px #ffd700;
    }
  </style>
</head>
<body>
  <div id="status">WebSocketï¼šæœªæ¥ç¶š</div>
  <button id="toggleSpeech">ğŸ”Š èª­ã¿ä¸Šã’ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
  <h1>ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ï¼ˆæ–°ç€ãŒä¸Šãƒ»èª­ã¿ä¸Šã’é †æ¬¡ï¼‰</h1>
  <div id="comments"></div>
  <script>
    let speechEnabled = false;
    let speechQueue = [];
    let isSpeaking = false;

    const statusDiv = document.getElementById("status");

    document.getElementById("toggleSpeech").onclick = function() {
      speechEnabled = !speechEnabled;
      if (speechEnabled) {
        const utter = new SpeechSynthesisUtterance("èª­ã¿ä¸Šã’ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ");
        utter.lang = 'ja-JP';
        window.speechSynthesis.speak(utter);
        this.textContent = "ğŸ”‡ èª­ã¿ä¸Šã’ã‚’ç„¡åŠ¹ã«ã™ã‚‹";
        this.classList.remove('off');
      } else {
        window.speechSynthesis.cancel();
        speechQueue = [];
        isSpeaking = false;
        this.textContent = "ğŸ”Š èª­ã¿ä¸Šã’ã‚’æœ‰åŠ¹ã«ã™ã‚‹";
        this.classList.add('off');
      }
    };

    // â˜…ã“ã“ã§WebSocketã‚µãƒ¼ãƒãƒ¼ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è‡ªåˆ†ã®ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´
    const ws = new WebSocket("ws://180.29.179.9:11180/sub?p=comments");

    ws.onopen = () => {
      statusDiv.textContent = "WebSocketï¼šæ¥ç¶šæˆåŠŸ";
      statusDiv.style.background = "#2a4";
    };

    ws.onclose = () => {
      statusDiv.textContent = "WebSocketï¼šæ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ";
      statusDiv.style.background = "#a44";
    };

    ws.onerror = e => {
      statusDiv.textContent = "WebSocketï¼šã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
      statusDiv.style.background = "#a44";
      console.error("WebSocketã‚¨ãƒ©ãƒ¼", e);
    };

    ws.onmessage = event => {
      statusDiv.textContent = "WebSocketï¼šé€šä¿¡ä¸­ï¼ˆå—ä¿¡ã‚ã‚Šï¼‰";
      statusDiv.style.background = "#48a";
      const msg = JSON.parse(event.data);
      if (
        (msg.type === "comments" || msg.type === "connected") &&
        msg.data &&
        Array.isArray(msg.data.comments)
      ) {
        msg.data.comments.forEach(obj => {
          if (
            obj.data &&
            typeof obj.data.comment === "string" &&
            obj.data.comment.trim() !== ""
          ) {
            const service =
              (obj.data.service || obj.service || "ä¸æ˜").toString();
            // ã‚®ãƒ•ãƒˆã‚³ãƒ¡ãƒ³ãƒˆåˆ¤å®š
            const isGift = !!obj.data.hasGift || !!obj.data.giftType;
            // é‡‘é¡å–å¾—ï¼ˆpaidTextå„ªå…ˆã€ãªã‘ã‚Œã°priceã‚’ä½¿ã†ï¼‰
            let amount = "";
            if (isGift) {
              if (obj.data.paidText) {
                amount = obj.data.paidText;
              } else if (typeof obj.data.price === "number") {
                amount = obj.data.price + "";
              }
            }
            // profileImageã®ã¿ä½¿ç”¨
            const iconUrl = obj.data.profileImage;
            // ã‚®ãƒ•ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã®ä¸­èº«ã‚’ãƒ­ã‚°å‡ºåŠ›
            if (isGift) {
              console.log("ã‚®ãƒ•ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿:", obj.data);
            }
            // èª­ã¿ä¸Šã’ç”¨ãƒ†ã‚­ã‚¹ãƒˆï¼ˆimgã‚¿ã‚°ãªã©ã‚’é™¤å»ï¼‰
            const speechText = stripHTML(obj.data.comment);
            addComment(
              obj.data.displayName,
              obj.data.comment,
              iconUrl,
              service,
              isGift,
              amount,
              speechText // â†è¿½åŠ 
            );
            if (msg.type === "comments" && speechEnabled) {
              enqueueSpeech(speechText);
            }
          }
        });
      }
    };

    // HTMLã‚¿ã‚°ã‚’é™¤å»ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã ã‘è¿”ã™é–¢æ•°
    function stripHTML(html) {
      // imgã‚¿ã‚°ã‚’é™¤å»ï¼ˆä»–ã®ã‚¿ã‚°ã‚‚æ¶ˆã—ãŸã„å ´åˆã¯æ­£è¦è¡¨ç¾ã‚’èª¿æ•´ï¼‰
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      // imgã‚¿ã‚°ã‚’å…¨ã¦å‰Šé™¤
      tmp.querySelectorAll('img').forEach(img => img.remove());
      return tmp.textContent || "";
    }

    function addComment(displayName, comment, iconUrl, service, isGift, amount, speechText) {
      const div = document.createElement("div");
      div.className = "comment";
      if (isGift) div.classList.add("gift");

      const img = document.createElement("img");
      img.className = "icon";
      img.src = iconUrl && iconUrl.trim() !== "" ? iconUrl : "https://static.wixstatic.com/media/ea8c7e_3c7c0b1e9c9b4a1b8c5e8b7e0b1c9b4a1~mv2.png";
      img.alt = "icon";
      div.appendChild(img);

      const content = document.createElement("div");
      content.className = "comment-content";

      const author = document.createElement("span");
      author.className = "author";
      author.textContent = displayName && displayName.trim() !== "" ? displayName : "åŒ¿å";
      content.appendChild(author);

      const body = document.createElement("span");
      body.className = "body";
      // çµµæ–‡å­—ç”»åƒãªã©ã‚’å«ã‚ã¦è¡¨ç¤º
      body.innerHTML = comment;
      content.appendChild(body);

      // é‡‘é¡è¡¨ç¤ºï¼ˆã‚®ãƒ•ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‹ã¤é‡‘é¡ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
      if (isGift && amount) {
        const amountSpan = document.createElement("span");
        amountSpan.className = "amount";
        amountSpan.textContent = amount;
        content.appendChild(amountSpan);
      }

      const serviceSpan = document.createElement("span");
      serviceSpan.className = "service";
      serviceSpan.textContent = service;
      content.appendChild(serviceSpan);

      div.appendChild(content);

      const commentsDiv = document.getElementById("comments");
      if (commentsDiv.firstChild) {
        commentsDiv.insertBefore(div, commentsDiv.firstChild);
      } else {
        commentsDiv.appendChild(div);
      }
    }

    function enqueueSpeech(text) {
      speechQueue.push(text);
      if (!isSpeaking) {
        playNextSpeech();
      }
    }

    function playNextSpeech() {
      if (!speechEnabled || speechQueue.length === 0) {
        isSpeaking = false;
        return;
      }
      isSpeaking = true;
      const text = speechQueue.shift();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ja-JP';
      utter.onend = function() {
        playNextSpeech();
      };
      utter.onerror = function() {
        playNextSpeech();
      };
      window.speechSynthesis.speak(utter);
    }
  </script>
</body>
</html>
